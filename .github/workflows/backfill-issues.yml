name: Backfill job issues

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to backfill'
        required: true
        type: number

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get issue
        id: get
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }} \
            > issue.json

          cat issue.json | jq .

      - name: Create job JSON from issue
        run: |
          mkdir -p jobs
          SLUG=$(jq -r '.body | fromjson | .slug' issue.json)
          echo $(jq -r '.body' issue.json) | jq . > "jobs/${SLUG}.json"

      - name: Rebuild index
        run: |
          jq -s '[ .[] | del(.descriptionHtml) ]' jobs/*.json > jobs/jobs.json

      - name: Commit files
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add jobs/*.json
          git commit -m "Backfill job from issue #${{ github.event.inputs.issue_number }}" || echo "No changes"
          git push
